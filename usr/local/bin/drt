#!/usr/bin/env bash
# drt - DHCP reservation tool (single /etc/dhcp/reservations.conf)
# Commands: new, update, search, list, delete, create-conf
# Behavior per user spec (one MAC per host, allow duplicate IPs, update uses regex)

RES_FILE="/etc/dhcp/reservations.conf"
DHCP_SERVICE="isc-dhcp-server"
CONF_FILE="/etc/dhcp/dhcpd.conf"

usage() {
    cat <<USG
Usage:
  drt new <IP> <MAC> <DNS_NAME>
  drt update <IP> <new_value>     (new_value can be MAC, IP, or hostname)
  drt search <query>
  drt list
  drt delete <DNS_NAME>
  drt create-conf
USG
    exit 1
}

# Regex checks
is_ip() {
    [[ $1 =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}$ ]] && return 0 || return 1
}
is_mac() {
    [[ $1 =~ ^([0-9A-Fa-f]{2}:){5}[0-9A-Fa-f]{2}$ ]] && return 0 || return 1
}
# Strict hostname: starts with letter, then letters/digits/hyphens, no trailing hyphen
is_hostname() {
    [[ $1 =~ ^[a-zA-Z][a-zA-Z0-9-]*[a-zA-Z0-9]$ ]] && return 0 || return 1
}

ensure_file() {
    mkdir -p "$(dirname "$RES_FILE")"
    touch "$RES_FILE"
}

reload_dhcp() {
    systemctl reload "$DHCP_SERVICE" 2>/dev/null || systemctl restart "$DHCP_SERVICE"
}

# List reservations nicely
cmd_list() {
    ensure_file
    printf "%-20s %-16s %-20s\n" "DNS Name" "IP" "MAC"
    echo "-----------------------------------------------------------------"
    # Use paragraph mode in awk to parse blocks
    awk 'BEGIN{RS="";FS="\n"} /host/{
        host=""
        ip=""
        mac=""
        for(i=1;i<=NF;i++){
            if($i ~ /^host[ \t]+/) { if(match($i,/^host[ \t]+([^\ \t{]+)/,m)) host=m[1] }
            if($i ~ /fixed-address/) { if(match($i,/fixed-address[ \t]+([0-9.]+)/,m)) ip=m[1] }
            if($i ~ /hardware ethernet/) { if(match($i,/hardware ethernet[ \t]+([0-9A-Fa-f:]+)/,m)) mac=m[1] }
        }
        if(host != "") printf "%-20s %-16s %-20s\n", host, ip, mac
    }' "$RES_FILE"
}

# Search
cmd_search() {
    ensure_file
    [ $# -ne 1 ] && usage
    QUERY="$1"
    cmd_list | grep -i -- "$QUERY" || echo "No matches found."
}

# New
cmd_new() {
    [ $# -ne 3 ] && usage
    IP="$1"; MAC="$2"; DNS="$3"

    ensure_file

    # Validate
    if ! is_ip "$IP"; then echo "Invalid IP: $IP"; exit 1; fi
    if ! is_mac "$MAC"; then echo "Invalid MAC: $MAC"; exit 1; fi
    if ! is_hostname "$DNS"; then
        echo "Invalid hostname: $DNS"
        echo "Hostnames must start with a letter, contain letters/digits/hyphens, and not end with a hyphen."
        exit 1
    fi

    # Remove existing block for same DNS if present
    if grep -qP "^host[ \t]+$DNS[ \t]*\{" "$RES_FILE"; then
        sudo sed -i "/^host[ \t]\+$DNS[ \t]*{/,/}/d" "$RES_FILE"
    fi

    # Append new block (use sudo tee for permission safety)
    {
        echo "host $DNS {"
        echo "    hardware ethernet $MAC;"
        echo "    fixed-address $IP;"
        echo "}"
        echo
    } | sudo tee -a "$RES_FILE" >/dev/null

    echo "Created reservation: $DNS -> $IP (MAC: $MAC)"
    # warn if IP already used by others
    warn_duplicates_for_ip "$IP" "$DNS"
    reload_dhcp
}

# Delete
cmd_delete() {
    [ $# -ne 1 ] && usage
    DNS="$1"
    ensure_file
    if ! grep -qP "^host[ \t]+$DNS[ \t]*\{" "$RES_FILE"; then
        echo "Host $DNS not found."
        exit 1
    fi
    sudo sed -i "/^host[ \t]\+$DNS[ \t]*{/,/}/d" "$RES_FILE"
    echo "Deleted host $DNS"
    reload_dhcp
}

# Helper: find hostnames for a given IP (returns newline-separated)
find_hosts_by_ip() {
    local ip="$1"
    awk -v ip="$ip" 'BEGIN{RS="";FS="\n"} $0 ~ ("fixed-address "ip";") {
        for(i=1;i<=NF;i++) if($i ~ /^host[ \t]+/) { if(match($i,/^host[ \t]+([^\ \t{]+)/,m)) print m[1] }
    }' "$RES_FILE"
}

# Update: ip + newval (mac/ip/hostname)
cmd_update() {
    [ $# -ne 2 ] && usage
    OLD_IP="$1"; NEWVAL="$2"

    ensure_file

    if ! is_ip "$OLD_IP"; then echo "First parameter must be an IP"; exit 1; fi

    # find matching hosts
    mapfile -t HOSTS < <(find_hosts_by_ip "$OLD_IP")
    if [ ${#HOSTS[@]} -eq 0 ]; then
        echo "No reservation blocks found with fixed-address $OLD_IP"
        exit 1
    fi

    CHANGED=()
    # If NEWVAL is MAC
    if is_mac "$NEWVAL"; then
        for h in "${HOSTS[@]}"; do
            # replace hardware ethernet line inside block
            sudo sed -i "/^host[[:space:]]\+$h[[:space:]]*{/,/}/ s/hardware ethernet[[:space:]]\+.*;/    hardware ethernet $NEWVAL;/" "$RES_FILE"
            CHANGED+=("$h")
            echo "Updated MAC for host '$h' -> $NEWVAL"
        done

    # If NEWVAL is IP
    elif is_ip "$NEWVAL"; then
        for h in "${HOSTS[@]}"; do
            sudo sed -i "/^host[[:space:]]\+$h[[:space:]]*{/,/}/ s/fixed-address[[:space:]]\+.*;/    fixed-address $NEWVAL;/" "$RES_FILE"
            CHANGED+=("$h")
            echo "Updated IP for host '$h' -> $NEWVAL"
        done

    # Else treat as hostname
    else
        if ! is_hostname "$NEWVAL"; then
            echo "Requested new hostname '$NEWVAL' is invalid. Must match strict hostname rules."; exit 1
        fi

        # If only one host matches, rename directly
        if [ ${#HOSTS[@]} -eq 1 ]; then
            old="${HOSTS[0]}"
            # replace host old {  with host new {
            sudo sed -i "s/^host[[:space:]]\+$old[[:space:]]*{[[:space:]]*$/host $NEWVAL {/" "$RES_FILE"
            CHANGED+=("$old->$NEWVAL")
            echo "Renamed host '$old' -> '$NEWVAL'"

        else
            # multiple hosts matched the same IP: rename sequentially new, new-1, new-2...
            i=0
            for old in "${HOSTS[@]}"; do
                if [ $i -eq 0 ]; then
                    newname="$NEWVAL"
                else
                    newname="${NEWVAL}-$i"
                fi
                # ensure newname doesn't already exist
                if grep -qP "^host[ \t]+$newname[ \t]*\{" "$RES_FILE"; then
                    echo "Warning: generated hostname '$newname' already exists; skipping rename of '$old'"
                    CHANGED+=("$old->(skipped:$newname)")
                else
                    sudo sed -i "s/^host[[:space:]]\+$old[[:space:]]*{[[:space:]]*$/host $newname {/" "$RES_FILE"
                    CHANGED+=("$old->$newname")
                    echo "Renamed host '$old' -> '$newname'"
                fi
                i=$((i+1))
            done
        fi
    fi

    # summary of applied changes
    echo
    echo "=== Applied changes ==="
    for c in "${CHANGED[@]}"; do
        echo " - $c"
    done
    echo "======================="

    # Now show duplicate-IP warnings (for all IPs)
    warn_all_duplicates

    reload_dhcp
}

# Print warnings for duplicates for provided IP (exclude the host we just changed if provided)
warn_duplicates_for_ip() {
    local ip="$1"
    local skip="$2" # optional host to skip in message
    mapfile -t hlist < <(find_hosts_by_ip "$ip")
    if [ ${#hlist[@]} -gt 1 ]; then
        echo
        echo "⚠ Warning: IP $ip is used by multiple hosts:"
        for hh in "${hlist[@]}"; do
            if [ "$hh" != "$skip" ]; then
                echo "  - $hh"
            else
                echo "  - $hh (just modified)"
            fi
        done
        echo
    fi
}

# Scan all reservations and warn for any IP with multiple hosts
warn_all_duplicates() {
    ensure_file
    awk 'BEGIN{RS="";FS="\n"} {
        ip=""
        hosts=""
        for(i=1;i<=NF;i++){
            if($i ~ /fixed-address/) if(match($i,/fixed-address[ \t]+([0-9.]+)/,m)) ip=m[1]
            if($i ~ /^host[ \t]+/) if(match($i,/^host[ \t]+([^\ \t{]+)/,m)) hosts = hosts " " m[1]
        }
        if(ip != "" ){
            gsub(/^ /,"",hosts)
            split(hosts,a," ")
            if(length(a) > 1) {
                printf "IP %s used by hosts: %s\n", ip, hosts
            }
        }
    }' "$RES_FILE" | while read -r line; do
        echo "⚠ Warning: $line"
    done
}

# create-conf: interactive
cmd_create_conf() {
    echo "Creating /etc/dhcp/dhcpd.conf..."
    read -p "Domain name (default: business.lan): " DOMAIN; DOMAIN=${DOMAIN:-business.lan}
    read -p "Default lease time (default: 600): " DLT; DLT=${DLT:-600}
    read -p "Max lease tim
