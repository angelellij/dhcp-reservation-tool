#!/usr/bin/env bash

RES_FILE="/etc/dhcp/reservations.conf"
DHCP_SERVICE="isc-dhcp-server"
CONF_FILE="/etc/dhcp/dhcpd.conf"

usage() {
    cat <<USG
Usage:
  drt add <IP> <MAC> <DNS_NAME>
    -> Creates a add static ip with the given data
  drt update <MAC, or DNS_NAME> <IP, MAC, or DNS_NAME>
    -> Replaces on found entry (using the first argument to search), the value (provided by the second argument)
  drt list
    -> Prints a list of all static ips data
  drt search <IP, MAC, or DNS_NAME>
    -> Searches in the list for the data associated to that IP, MAC or DNS
  drt remove <IP, MAC, or DNS_NAME>
    -> Removes all entries related to that IP, MAC or DNS
  drt create-conf
    -> Creates/Replaces /etc/dhcp/dhcpd.conf with a config file made through interactive CLI
USG
    exit 1
}

# ---------------------------
# VALIDATION HELPERS
# ---------------------------

is_ip() {
    [[ $1 =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}$ ]]
}

is_mac() {
    [[ $1 =~ ^([0-9A-Fa-f]{2}:){5}[0-9A-Fa-f]{2}$ ]]
}

mac_exists() {
    local mac_up
    mac_up="$(echo "$1" | tr 'a-f' 'A-F')"

    grep -qi "hardware[[:space:]]\+ethernet[[:space:]]\+$mac_up;" "$RES_FILE"
}


is_hostname() {
    [[ $1 =~ ^[A-Za-z][A-Za-z0-9-]*[A-Za-z0-9]$ ]]
}

hostname_exists() {
    local name="$1"
    grep -q "^host[[:space:]]\+$name[[:space:]]*{" "$RES_FILE"
}

ensure_file() {
    mkdir -p "$(dirname "$RES_FILE")"
    touch "$RES_FILE"
}

reload_dhcp() {
    systemctl reload "$DHCP_SERVICE" 2>/dev/null || systemctl restart "$DHCP_SERVICE"
}

classify_arg() {
    local arg="$1"

    if is_ip "$arg"; then
        echo "ip"
        return 0
    fi

    if is_mac "$arg"; then
        echo "mac"
        return 0
    fi

    if is_hostname "$arg"; then
        echo "dns"
        return 0
    fi
    echo "other"
    return 0
}

# ---------------------------
# HELPERS FUNCTIONS
# ---------------------------

find_hosts_by_ip() {
    local ip="$1"
    awk -v ip="$ip" '
        BEGIN {RS=""; FS="\n"}
        {
            host=""; has_ip=0
            for(i=1;i<=NF;i++){
                line=$i

                if (line ~ /^host[ \t]+/) {
                    t=line
                    sub(/^host[ \t]+/, "", t)
                    sub(/[ \t]*\{.*$/, "", t)
                    host=t
                }

                if (line ~ ("fixed-address " ip ";"))
                    has_ip=1
            }
            if (has_ip && host != "") print host
        }
    ' "$RES_FILE"
}

warn_duplicates_for_ip() {
    local ip="$1"
    local skip="$2"

    mapfile -t hlist < <(find_hosts_by_ip "$ip")
    if [ ${#hlist[@]} -gt 1 ]; then
        echo
        echo "âš  Warning: Multiple hosts use IP $ip:"
        for h in "${hlist[@]}"; do
            if [ "$h" == "$skip" ]; then
                echo "  - $h (just modified)"
            else
                echo "  - $h"
            fi
        done
        echo
    fi
}

# ---------------------------
# LIST
# ---------------------------

cmd_list() {
    printf "%-20s %-16s %-20s\n" "DNS Name" "IP" "MAC"
    echo "-----------------------------------------------------------------"

    awk '
    BEGIN { RS="}"; FS="\n" }

    /host[ \t]+/ {
        host=""; ip=""; mac=""

        for (i=1; i<=NF; i++) {
            line = $i

            # HOST
            if (line ~ /^host[ \t]+/) {
                t=line
                sub(/^host[ \t]+/, "", t)
                sub(/[ \t]*\{.*$/, "", t)
                sub(/^[ \t]+/, "", t); sub(/[ \t]+$/, "", t)
                host=t
            }

            # IP
            if (line ~ /fixed-address/) {
                t=line
                sub(/.*fixed-address[ \t]+/, "", t)
                sub(/;.*/, "", t)
                sub(/^[ \t]+/, "", t); sub(/[ \t]+$/, "", t)
                ip=t
            }

            # MAC
            if (line ~ /hardware ethernet/) {
                t=line
                sub(/.*hardware ethernet[ \t]+/, "", t)
                sub(/;.*/, "", t)
                sub(/^[ \t]+/, "", t); sub(/[ \t]+$/, "", t)
                mac=t
            }
        }

        if (host != "")
            printf "%-20s %-16s %-20s\n", host, ip, mac
    }' "$RES_FILE"
}


# ---------------------------
# SEARCH
# ---------------------------

cmd_search() {
    [ $# -ne 1 ] && usage
    if [ "$(classify_arg "$1")" = "other" ]; then
        echo "Argument is not an IP, MAC or valid DNS: $1"
    fi
    cmd_list | grep -i -- "$1 " || echo "No matches found."
}

# ---------------------------
# ADD
# ---------------------------

cmd_add() {
    [ $# -ne 3 ] && usage
    IP="$1"; MAC="$2"; DNS="$3"

    ensure_file

    if ! is_ip "$IP"; then 
        echo "Invalid IP: $IP"; 
        exit 1; 
    fi
    if ! is_mac "$MAC"; then 
        echo "Invalid MAC: $MAC"; 
        exit 1; 
    fi
    if mac_exists "$MAC"; then 
        echo "MAC already exists.: $MAC"; 
        exit 1; 
    fi
    if ! is_hostname "$DNS"; then
        echo "Invalid hostname: $DNS"
        echo "Hostnames must start with a letter, contain letters/digits/hyphens, and not end with a hyphen."
        exit 1
    fi
    if hostname_exists "$DNS"; then
        echo "Hostname already exists: $DNS"
        exit 1
    fi

    # Remove existing host block if exists
    sudo sed -i "/^host[[:space:]]\+$DNS[[:space:]]*{/,/}/d" "$RES_FILE"

    {
        echo "host $DNS {"
        echo "    hardware ethernet $MAC;"
        echo "    fixed-address $IP;"
        echo "}"
    } | sudo tee -a "$RES_FILE" >/dev/null

    echo "Created reservation: $DNS -> $IP (MAC: $MAC)"
    warn_duplicates_for_ip "$IP" "$DNS"
    reload_dhcp
}

# ---------------------------
# REMOVE
# ---------------------------

cmd_remove() {
    [ $# -ne 1 ] && usage
    local arg="$1"

    local value
    value="$(drt search "$arg" | grep -i -- "$arg" | awk '{print $1}')"

    if [ -z "$value" ]; then
        echo "Nothing removed. No DNS/IP/MAC matched: $arg"
        return 1
    fi

    # Process each matched DNS record
    while read -r dns; do
        [ -z "$value" ] && continue

        if hostname_exists "$value"; then
            sed -i "/^host[[:space:]]\+$dns[[:space:]]*{/,/}/d" "$RES_FILE"
            echo "Removed reservation for DNS: $dns"
        fi
    done <<< "$value"

    reload_dhcp
}

# ---------------------------
# UPDATE
# ---------------------------

cmd_update() {
    [ $# -ne 2 ] && usage

    ARG="$1"      # Search Argument (DNS or MAC)
    NEWVAL="$2"   # New Value (DNS, MAC, or IP)

    ARG_TYPE=$(classify_arg "$ARG")
    NEWVAL_TYPE=$(classify_arg "$NEWVAL")

    if [[ "$ARG_TYPE" == "other" || "$NEWVAL_TYPE" == "other" ]]; then
        echo "Error: Invalid argument(s). First argument must be DNS or MAC, second must be DNS, MAC, or IP."
        exit 1
    fi

    # Find entry
    if [ "$ARG_TYPE" = "mac" ]; then
        
        HOST=$(cmd_list | awk -v mac="$ARG" '$3 ~ mac {print $1}')
        if [ -z "$HOST" ]; then
            echo "No host found with MAC $ARG"
            exit 1
        fi
    elif [ "$ARG_TYPE" = "dns" ]; then
        if ! hostname_exists "$ARG"; then
            echo "No host found with DNS $ARG"
            exit 1
        fi
        HOST="$ARG"
    else
        echo "Error: Invalid argument. First argument must be a DNS or MAC"
        exit 1
    fi

    # Modify entry
    if [ "$NEWVAL_TYPE" = "mac" ]; then
        if mac_exists "$NEWVAL"; then
            echo "Error: MAC $NEWVAL already exists"
            exit 1
        fi
        sudo sed -i "/^host[[:space:]]\+$HOST[[:space:]]*{/,/}/ s/hardware ethernet[[:space:]]\+.*;/    hardware ethernet $NEWVAL;/" "$RES_FILE"
        echo "Updated MAC for $HOST -> $NEWVAL"

    elif [ "$NEWVAL_TYPE" = "ip" ]; then
        sudo sed -i "/^host[[:space:]]\+$HOST[[:space:]]*{/,/}/ s/fixed-address[[:space:]]\+.*;/    fixed-address $NEWVAL;/" "$RES_FILE"
        echo "Updated IP for $HOST -> $NEWVAL"

    elif [ "$NEWVAL_TYPE" = "dns" ]; then
        if hostname_exists "$NEWVAL"; then
            echo "Error: hostname '$NEWVAL' already exists"
            exit 1
        fi
        sudo sed -i "s/^host[[:space:]]\+$HOST[[:space:]]*{/host $NEWVAL {/" "$RES_FILE"
        echo "Renamed host '$HOST' -> '$NEWVAL'"
    fi

    reload_dhcp
}

# ---------------------------
# CREATE-CONF
# ---------------------------

cmd_create_conf() {
    echo "Creating $CONF_FILE..."

    read -p "Domain (default business.lan): " DOMAIN
    DOMAIN=${DOMAIN:-business.lan}

    read -p "Default lease time (600): " DLT
    DLT=${DLT:-600}

    read -p "Max lease time (7200): " MLT
    MLT=${MLT:-7200}

    read -p "Subnet (192.168.1.0): " SUBNET
    SUBNET=${SUBNET:-192.168.1.0}

    read -p "Netmask (255.255.255.0): " NETMASK
    NETMASK=${NETMASK:-255.255.255.0}

    read -p "Range start (192.168.1.100): " RS
    RS=${RS:-192.168.1.100}

    read -p "Range end   (192.168.1.200): " RE
    RE=${RE:-192.168.1.200}

    read -p "Router (192.168.1.1): " ROUTER
    ROUTER=${ROUTER:-192.168.1.1}

    read -p "DNS servers (8.8.8.8, 4.4.4.4): " DNS
    DNS=${DNS:-8.8.8.8, 4.4.4.4}

    ensure_file

    cat <<EOF | sudo tee "$CONF_FILE" >/dev/null
option domain-name "$DOMAIN";
option domain-name-servers $DNS;
default-lease-time $DLT;
max-lease-time $MLT;
authoritative;

subnet $SUBNET netmask $NETMASK {
    range $RS $RE;
    option routers $ROUTER;
}

include "$RES_FILE";
EOF

    echo "Wrote $CONF_FILE"

    if dhcpd -t -cf "$CONF_FILE" 2>/tmp/dhcpd_test.err; then
        echo "dhcpd config OK"
        systemctl restart "$DHCP_SERVICE"
    else
        echo "dhcpd config FAILED"
        sed -n '1,200p' /tmp/dhcpd_test.err
    fi
}

# ---------------------------
# DISPATCH
# ---------------------------

case "$1" in
    add) shift; cmd_add "$@" ;;
    update) shift; cmd_update "$@" ;;
    search) shift; cmd_search "$@" ;;
    list) cmd_list ;;
    remove) shift; cmd_remove "$@" ;;
    create-conf) cmd_create_conf ;;
    *) usage ;;
esac
