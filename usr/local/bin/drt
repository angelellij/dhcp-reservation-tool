#!/usr/bin/env bash
# drt - DHCP reservation tool (single /etc/dhcp/reservations.conf)
# Commands: new, update, search, list, delete, create-conf

RES_FILE="/etc/dhcp/reservations.conf"
DHCP_SERVICE="isc-dhcp-server"
CONF_FILE="/etc/dhcp/dhcpd.conf"

usage() {
    cat <<USG
Usage:
  drt new <IP> <MAC> <DNS_NAME>
  drt update <IP> <new_value>     (new_value can be MAC, IP, or hostname)
  drt search <query>
  drt list
  drt delete <DNS_NAME>
  drt create-conf
USG
    exit 1
}

# ---------------------------
# VALIDATION HELPERS
# ---------------------------

is_ip() {
    [[ $1 =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}$ ]]
}

is_mac() {
    [[ $1 =~ ^([0-9A-Fa-f]{2}:){5}[0-9A-Fa-f]{2}$ ]]
}

mac_exists() {
    local mac_up
    mac_up="$(echo "$1" | tr 'a-f' 'A-F')"

    grep -qi "hardware[[:space:]]\+ethernet[[:space:]]\+$mac_up;" "$RES_FILE"
}


is_hostname() {
    [[ $1 =~ ^[A-Za-z][A-Za-z0-9-]*[A-Za-z0-9]$ ]]
}

hostname_exists() {
    local name="$1"
    grep -q "^host[[:space:]]\+$name[[:space:]]*{" "$RES_FILE"
}

ensure_file() {
    mkdir -p "$(dirname "$RES_FILE")"
    touch "$RES_FILE"
}

reload_dhcp() {
    systemctl reload "$DHCP_SERVICE" 2>/dev/null || systemctl restart "$DHCP_SERVICE"
}

# ---------------------------
# LIST
# ---------------------------

cmd_list() {
    printf "%-20s %-16s %-20s\n" "DNS Name" "IP" "MAC"
    echo "-----------------------------------------------------------------"

    awk '
        BEGIN { RS=""; FS="\n" }
        /host[ \t]+/ {
            host=""; ip=""; mac=""
            for(i=1;i<=NF;i++){
                line=$i

                # host
                if (line ~ /^host[ \t]+/) {
                    t=line
                    sub(/^host[ \t]+/, "", t)
                    sub(/[ \t]*\{.*$/, "", t)
                    host=t
                }

                # IP
                if (line ~ /fixed-address/) {
                    t=line
                    sub(/.*fixed-address[ \t]+/, "", t)
                    sub(/;.*/, "", t)
                    ip=t
                }

                # MAC
                if (line ~ /hardware ethernet/) {
                    t=line
                    sub(/.*hardware ethernet[ \t]+/, "", t)
                    sub(/;.*/, "", t)
                    mac=t
                }
            }

            if (host != "")
                printf "%-20s %-16s %-20s\n", host, ip, mac
        }
    ' "$RES_FILE"
}

# ---------------------------
# SEARCH
# ---------------------------

cmd_search() {
    [ $# -ne 1 ] && usage
    cmd_list | grep -i -- "$1" || echo "No matches found."
}

# ---------------------------
# NEW
# ---------------------------

cmd_new() {
    [ $# -ne 3 ] && usage
    IP="$1"; MAC="$2"; DNS="$3"

    ensure_file

    if ! is_ip "$IP"; then 
        echo "Invalid IP: $IP"; 
        exit 1; 
    fi
    if ! is_mac "$MAC"; then 
        echo "Invalid MAC: $MAC"; 
        exit 1; 
    fi
    if mac_exists "$MAC"; then 
        echo "MAC already exists.: $MAC"; 
        exit 1; 
    fi
    if ! is_hostname "$DNS"; then
        echo "Invalid hostname: $DNS"
        echo "Hostnames must start with a letter, contain letters/digits/hyphens, and not end with a hyphen."
        exit 1
    fi
    if hostname_exists "$DNS"; then
        echo "Hostname already exists: $DNS"
        exit 1
    fi

    # Remove existing host block if exists
    sudo sed -i "/^host[[:space:]]\+$DNS[[:space:]]*{/,/}/d" "$RES_FILE"

    {
        echo "host $DNS {"
        echo "    hardware ethernet $MAC;"
        echo "    fixed-address $IP;"
        echo "}"
        echo
    } | sudo tee -a "$RES_FILE" >/dev/null

    echo "Created reservation: $DNS -> $IP (MAC: $MAC)"
    warn_duplicates_for_ip "$IP" "$DNS"
    reload_dhcp
}

# ---------------------------
# DELETE
# ---------------------------

cmd_delete() {
    local arg="$1"
    local arg_up
    arg_up="$(echo "$arg" | tr 'a-f' 'A-F')"

    # --- CASE: DNS NAME ---------------------------------------------------------
    if dns_exists "$arg"; then
        # Remove the whole host {} block
        sed -i "/host[[:space:]]\+$arg[[:space:]]*{/,/}/d" "$RES_FILE"

        echo "Deleted reservation for DNS name: $arg"
        return 0
    fi

    # --- CASE: MAC ADDRESS ------------------------------------------------------
    if mac_exists "$arg"; then
        # Delete only the MAC line from its block
        sed -i "/hardware[[:space:]]\+ethernet[[:space:]]\+$arg_up;/d" "$RES_FILE"

        echo "Deleted MAC address: $arg_up"
        echo "Warning: Reservation block may now be incomplete if no MACs remain."
        return 0
    fi

    # --- CASE: IP ADDRESS -------------------------------------------------------
    if ip_exists "$arg"; then
        # Remove entire blocks matching this IP
        sed -i "/fixed-address[[:space:]]\+$arg;/,/}/d" "$RES_FILE"

        echo "Deleted reservation(s) for IP: $arg"
        return 0
    fi

    # --- NOT FOUND --------------------------------------------------------------
    echo "Nothing deleted. No DNS name, MAC, or IP matched: $arg" >&2
    return 1
}

# ---------------------------
# HELPERS FOR UPDATE
# ---------------------------

find_hosts_by_ip() {
    local ip="$1"
    awk -v ip="$ip" '
        BEGIN {RS=""; FS="\n"}
        {
            host=""; has_ip=0
            for(i=1;i<=NF;i++){
                line=$i

                if (line ~ /^host[ \t]+/) {
                    t=line
                    sub(/^host[ \t]+/, "", t)
                    sub(/[ \t]*\{.*$/, "", t)
                    host=t
                }

                if (line ~ ("fixed-address " ip ";"))
                    has_ip=1
            }
            if (has_ip && host != "") print host
        }
    ' "$RES_FILE"
}

warn_duplicates_for_ip() {
    local ip="$1"
    local skip="$2"

    mapfile -t hlist < <(find_hosts_by_ip "$ip")
    if [ ${#hlist[@]} -gt 1 ]; then
        echo
        echo "⚠ Warning: Multiple hosts use IP $ip:"
        for h in "${hlist[@]}"; do
            if [ "$h" == "$skip" ]; then
                echo "  - $h (just modified)"
            else
                echo "  - $h"
            fi
        done
        echo
    fi
}

warn_all_duplicates() {
    ensure_file
    awk '
        BEGIN { RS=""; FS="\n" }
        {
            hosts=""; ip=""
            for(i=1;i<=NF;i++){
                line=$i

                if (line ~ /^host[ \t]+/) {
                    t=line
                    sub(/^host[ \t]+/, "", t)
                    sub(/[ \t]*\{.*$/, "", t)
                    hosts = hosts " " t
                }

                if (line ~ /fixed-address/) {
                    t=line
                    sub(/.*fixed-address[ \t]+/, "", t)
                    sub(/;.*/, "", t)
                    ip=t
                }
            }

            if (ip != "") {
                sub(/^ /, "", hosts)
                split(hosts, arr, " ")
                if (length(arr) > 1)
                    print "⚠ Warning: IP " ip " used by hosts:" hosts
            }
        }
    ' "$RES_FILE"
}

# ---------------------------
# UPDATE
# ---------------------------

cmd_update() {
    [ $# -ne 2 ] && usage

    OLD_IP="$1"
    NEWVAL="$2"

    ensure_file

    if ! is_ip "$OLD_IP"; then 
        echo "First parameter must be an IP address."
        exit 1
    fi

    # Find hosts matching old IP
    mapfile -t HOSTS < <(find_hosts_by_ip "$OLD_IP")

    if [ ${#HOSTS[@]} -eq 0 ]; then
        echo "No hosts with fixed-address $OLD_IP"
        exit 1
    fi

    CHANGED=()

    # -----------------------------------------------------------
    # CASE 1 — MAC UPDATE
    # -----------------------------------------------------------
    if is_mac "$NEWVAL"; then
        if mac_exists "$NEWVAL"; then
            echo "Error: MAC already exists elsewhere: $NEWVAL"
            exit 1
        fi

        for h in "${HOSTS[@]}"; do
            sudo sed -i \
                "/^host[[:space:]]\+$h[[:space:]]*{/,/}/ s/hardware ethernet[[:space:]]\+.*;/    hardware ethernet $NEWVAL;/" \
                "$RES_FILE"

            echo "Updated MAC for $h -> $NEWVAL"
            CHANGED+=("MAC change: $h -> $NEWVAL")
        done

    # -----------------------------------------------------------
    # CASE 2 — IP UPDATE
    # -----------------------------------------------------------
    elif is_ip "$NEWVAL"; then
        for h in "${HOSTS[@]}"; do
            sudo sed -i \
                "/^host[[:space:]]\+$h[[:space:]]*{/,/}/ s/fixed-address[[:space:]]\+.*;/    fixed-address $NEWVAL;/" \
                "$RES_FILE"

            echo "Updated IP for $h -> $NEWVAL"
            CHANGED+=("IP change: $h -> $NEWVAL")
        done

    # -----------------------------------------------------------
    # CASE 3 — HOSTNAME UPDATE
    # -----------------------------------------------------------
    else
        if ! is_hostname "$NEWVAL"; then
            echo "Invalid hostname: $NEWVAL"
            exit 1
        fi

        # Only one host should match because you disallowed multiple-MAC blocks
        old="${HOSTS[0]}"

        # Check if new hostname exists
        if hostname_exists "$NEWVAL"; then
            echo "Error: Hostname '$NEWVAL' already exists."
            exit 1
        fi

        sudo sed -i \
            "s/^host[[:space:]]\+$old[[:space:]]*{/host $NEWVAL {/" \
            "$RES_FILE"

        echo "Renamed host '$old' -> '$NEWVAL'"
        CHANGED+=("Rename: $old -> $NEWVAL")
    fi

    # -----------------------------------------------------------
    # SUMMARY + WARNINGS
    # -----------------------------------------------------------
    echo
    echo "=== Applied changes ==="
    for c in "${CHANGED[@]}"; do
        echo " - $c"
    done
    echo "======================="

    warn_all_duplicates
    reload_dhcp
}


# ---------------------------
# CREATE-CONF
# ---------------------------

cmd_create_conf() {
    echo "Creating $CONF_FILE..."

    read -p "Domain (default business.lan): " DOMAIN
    DOMAIN=${DOMAIN:-business.lan}

    read -p "Default lease time (600): " DLT
    DLT=${DLT:-600}

    read -p "Max lease time (7200): " MLT
    MLT=${MLT:-7200}

    read -p "Subnet (192.168.1.0): " SUBNET
    SUBNET=${SUBNET:-192.168.1.0}

    read -p "Netmask (255.255.255.0): " NETMASK
    NETMASK=${NETMASK:-255.255.255.0}

    read -p "Range start (192.168.1.100): " RS
    RS=${RS:-192.168.1.100}

    read -p "Range end   (192.168.1.200): " RE
    RE=${RE:-192.168.1.200}

    read -p "Router (192.168.1.1): " ROUTER
    ROUTER=${ROUTER:-192.168.1.1}

    read -p "DNS servers (8.8.8.8, 4.4.4.4): " DNS
    DNS=${DNS:-8.8.8.8, 4.4.4.4}

    ensure_file

    cat <<EOF | sudo tee "$CONF_FILE" >/dev/null
option domain-name "$DOMAIN";
option domain-name-servers $DNS;
default-lease-time $DLT;
max-lease-time $MLT;
authoritative;

subnet $SUBNET netmask $NETMASK {
    range $RS $RE;
    option routers $ROUTER;
}

include "$RES_FILE";
EOF

    echo "Wrote $CONF_FILE"

    if dhcpd -t -cf "$CONF_FILE" 2>/tmp/dhcpd_test.err; then
        echo "dhcpd config OK"
        systemctl restart "$DHCP_SERVICE"
    else
        echo "dhcpd config FAILED"
        sed -n '1,200p' /tmp/dhcpd_test.err
    fi
}

# ---------------------------
# DISPATCH
# ---------------------------

case "$1" in
    new) shift; cmd_new "$@" ;;
    update) shift; cmd_update "$@" ;;
    search) shift; cmd_search "$@" ;;
    list) cmd_list ;;
    delete) shift; cmd_delete "$@" ;;
    create-conf) cmd_create_conf ;;
    *) usage ;;
esac
